# =============================================================================
# LEVEL 1: COMPOSITE ACTION - Terraform Plan
# =============================================================================
# Reusable action for running Terraform plan and capturing output
# =============================================================================

name: 'Terraform Plan'
description: 'Run Terraform plan and capture changes'
author: 'Azure Landing Zone Lab'

inputs:
  var_file:
    description: 'Path to variables file'
    required: true
  working_directory:
    description: 'Working directory for Terraform'
    required: false
    default: '.'
  plan_file:
    description: 'Output plan file name'
    required: false
    default: 'tfplan'

outputs:
  has_changes:
    description: 'Whether the plan has changes (true/false)'
    value: ${{ steps.plan.outputs.has_changes }}
  add:
    description: 'Number of resources to add'
    value: ${{ steps.summary.outputs.add }}
  change:
    description: 'Number of resources to change'
    value: ${{ steps.summary.outputs.change }}
  destroy:
    description: 'Number of resources to destroy'
    value: ${{ steps.summary.outputs.destroy }}

runs:
  using: 'composite'
  steps:
    - name: Terraform Plan
      id: plan
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        set +e
        set -o pipefail
        terraform plan \
          -var-file="${{ inputs.var_file }}" \
          -out=${{ inputs.plan_file }} \
          -detailed-exitcode \
          -no-color 2>&1 | tee plan_output.txt
        
        EXITCODE=${PIPESTATUS[0]}
        
        if [ $EXITCODE -eq 0 ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "## âœ… No Changes Detected" >> $GITHUB_STEP_SUMMARY
        elif [ $EXITCODE -eq 2 ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "## âŒ Plan Failed" >> $GITHUB_STEP_SUMMARY
          cat plan_output.txt
          exit 1
        fi

    - name: Parse Plan Output
      id: summary
      shell: bash
      working-directory: ${{ inputs.working_directory }}
      run: |
        ADD=$(grep -oP '\d+(?= to add)' plan_output.txt || echo "0")
        CHANGE=$(grep -oP '\d+(?= to change)' plan_output.txt || echo "0")
        DESTROY=$(grep -oP '\d+(?= to destroy)' plan_output.txt || echo "0")
        
        echo "add=$ADD" >> $GITHUB_OUTPUT
        echo "change=$CHANGE" >> $GITHUB_OUTPUT
        echo "destroy=$DESTROY" >> $GITHUB_OUTPUT
        
        if [ "${{ steps.plan.outputs.has_changes }}" == "true" ]; then
          echo "## ðŸ“‹ Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âž• Add | $ADD |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Change | $CHANGE |" >> $GITHUB_STEP_SUMMARY
          echo "| âž– Destroy | $DESTROY |" >> $GITHUB_STEP_SUMMARY
        fi
