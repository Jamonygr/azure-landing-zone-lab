# =============================================================================
# LEVEL 3: ORCHESTRATOR PIPELINE - Main Terraform Workflow
# =============================================================================
# This is the main entry point that orchestrates all reusable workflows
# Level 1: Composite Actions (in .github/actions/)
# Level 2: Reusable Workflows (reusable-*.yml)
# Level 3: This orchestrator (terraform-orchestrator.yml)
# =============================================================================

name: 'Terraform - ALZ Pipeline'

on:
  push:
    branches:
      - main
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
    paths:
      - '**.tf'
      - '**.tfvars'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'lab'
        type: choice
        options:
          - dev
          - lab
          - prod
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      destroy_confirm:
        description: 'Type DESTROY to confirm destruction'
        required: false
        type: string

env:
  TF_VERSION: '1.9.0'
  WORKING_DIR: '.'

permissions:
  contents: read
  pull-requests: write
  security-events: write
  id-token: write

jobs:
  # ===========================================================================
  # Stage 1: Validate
  # ===========================================================================
  validate:
    name: 'Validate'
    uses: ./.github/workflows/reusable-validate.yml
    with:
      terraform_version: '1.9.0'
      working_directory: '.'

  # ===========================================================================
  # Stage 2: Security Scans
  # ===========================================================================
  security:
    name: 'Security'
    needs: validate
    uses: ./.github/workflows/reusable-security.yml
    with:
      working_directory: '.'
      run_tfsec: true
      run_checkov: true
      run_tflint: true
      soft_fail: true

  # ===========================================================================
  # Stage 3: Plan
  # ===========================================================================
  plan:
    name: 'Plan'
    needs: security
    uses: ./.github/workflows/reusable-plan.yml
    with:
      terraform_version: '1.9.0'
      working_directory: '.'
      environment: ${{ github.event.inputs.environment || 'lab' }}
      var_file: 'environments/${{ github.event.inputs.environment || ''lab'' }}.tfvars'
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_SA: ${{ secrets.TF_STATE_SA }}

  # ===========================================================================
  # Stage 4: Apply (only on workflow_dispatch with action=apply)
  # ===========================================================================
  apply:
    name: 'Apply'
    needs: plan
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'apply' &&
      needs.plan.outputs.has_changes == 'true'
    uses: ./.github/workflows/reusable-apply.yml
    with:
      terraform_version: '1.9.0'
      working_directory: '.'
      environment: ${{ github.event.inputs.environment }}
      plan_artifact: 'tfplan-${{ github.event.inputs.environment }}-${{ github.sha }}'
      add_count: ${{ needs.plan.outputs.add }}
      change_count: ${{ needs.plan.outputs.change }}
      destroy_count: ${{ needs.plan.outputs.destroy }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_SA: ${{ secrets.TF_STATE_SA }}

  # ===========================================================================
  # Stage 5: Destroy (only on workflow_dispatch with action=destroy)
  # ===========================================================================
  destroy:
    name: 'Destroy'
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'destroy'
    uses: ./.github/workflows/reusable-destroy.yml
    with:
      terraform_version: '1.9.0'
      working_directory: '.'
      environment: ${{ github.event.inputs.environment }}
      var_file: 'environments/${{ github.event.inputs.environment }}.tfvars'
      destroy_confirm: ${{ github.event.inputs.destroy_confirm }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_SA: ${{ secrets.TF_STATE_SA }}

  # ===========================================================================
  # Summary Job
  # ===========================================================================
  summary:
    name: 'Pipeline Summary'
    runs-on: ubuntu-latest
    needs: [validate, security, plan]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ Azure Landing Zone Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Plan | ${{ needs.plan.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** \`${{ github.event.inputs.environment || 'lab' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Action:** \`${{ github.event.inputs.action || 'plan' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
