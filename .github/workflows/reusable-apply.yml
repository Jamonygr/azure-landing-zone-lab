# =============================================================================
# LEVEL 2: REUSABLE WORKFLOW - Apply
# =============================================================================
# Reusable workflow for Terraform apply
# =============================================================================

name: Terraform Apply

on:
  workflow_call:
    inputs:
      terraform_version:
        description: 'Terraform version'
        type: string
        required: false
        default: '1.9.0'
      working_directory:
        description: 'Working directory'
        type: string
        required: false
        default: '.'
      environment:
        description: 'Target environment'
        type: string
        required: true
      plan_artifact:
        description: 'Plan artifact name'
        type: string
        required: true
      add_count:
        description: 'Resources to add (for summary)'
        type: string
        required: false
        default: '0'
      change_count:
        description: 'Resources to change (for summary)'
        type: string
        required: false
        default: '0'
      destroy_count:
        description: 'Resources to destroy (for summary)'
        type: string
        required: false
        default: '0'
    secrets:
      AZURE_CREDENTIALS:
        required: true
      TF_STATE_RG:
        required: true
      TF_STATE_SA:
        required: true

jobs:
  apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: https://portal.azure.com
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        working-directory: ${{ inputs.working_directory }}
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RG }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_SA }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ inputs.environment }}.terraform.tfstate"

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.plan_artifact }}
          path: ${{ inputs.working_directory }}

      - name: Terraform Apply
        working-directory: ${{ inputs.working_directory }}
        run: |
          terraform apply -auto-approve tfplan 2>&1 | tee apply_output.txt
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "## âŒ Apply Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Apply Summary
        run: |
          echo "## âœ… Terraform Apply Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âž• Added | ${{ inputs.add_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Changed | ${{ inputs.change_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âž– Destroyed | ${{ inputs.destroy_count }} |" >> $GITHUB_STEP_SUMMARY

      - name: Show Outputs
        working-directory: ${{ inputs.working_directory }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Outputs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform output -no-color >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No outputs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
