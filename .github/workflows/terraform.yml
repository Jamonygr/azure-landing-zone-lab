# =============================================================================
# TERRAFORM PIPELINE - Azure Landing Zone
# =============================================================================
# This is the ONLY visible pipeline in GitHub Actions.
# It orchestrates reusable workflows (Level 2) which use composite actions (Level 1).
#
# Architecture:
#   Level 3: This file (terraform.yml) - Single entry point
#   Level 2: _validate.yml, _security.yml, _plan.yml, _apply.yml, _destroy.yml
#   Level 1: .github/actions/* - Composite actions
# =============================================================================

name: 'Terraform Pipeline'

on:
  push:
    branches: [main]
    paths: ['**.tf', '**.tfvars', 'modules/**', 'landing-zones/**', 'environments/**']
  pull_request:
    branches: [main]
    paths: ['**.tf', '**.tfvars']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'lab'
        type: choice
        options: [dev, lab, prod]
      action:
        description: 'Action'
        required: true
        default: 'plan'
        type: choice
        options: [plan, apply, destroy]
      destroy_confirm:
        description: 'Type DESTROY to confirm'
        required: false
        type: string

concurrency:
  group: terraform-${{ github.ref }}-${{ github.event.inputs.environment || 'lab' }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write
  security-events: write
  id-token: write

jobs:
  # =========================================================================
  # Stage 1: Validate (uses Level 2 reusable workflow)
  # =========================================================================
  validate:
    uses: ./.github/workflows/_validate.yml
    with:
      terraform_version: '1.9.0'

  # =========================================================================
  # Stage 2: Security Scans (uses Level 2 reusable workflow)
  # =========================================================================
  security:
    needs: validate
    uses: ./.github/workflows/_security.yml
    with:
      soft_fail: true

  # =========================================================================
  # Stage 3: Plan (uses Level 2 reusable workflow → Level 1 composite actions)
  # =========================================================================
  plan:
    needs: security
    uses: ./.github/workflows/_plan.yml
    with:
      terraform_version: '1.9.0'
      environment: ${{ github.event.inputs.environment || 'lab' }}
      var_file: environments/${{ github.event.inputs.environment || 'lab' }}.tfvars
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_SA: ${{ secrets.TF_STATE_SA }}

  # =========================================================================
  # Stage 4: Apply (uses Level 2 reusable workflow → Level 1 composite actions)
  # =========================================================================
  apply:
    needs: plan
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'apply' &&
      needs.plan.outputs.has_changes == 'true'
    uses: ./.github/workflows/_apply.yml
    with:
      terraform_version: '1.9.0'
      environment: ${{ github.event.inputs.environment }}
      plan_artifact: tfplan-${{ github.event.inputs.environment }}-${{ github.sha }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_SA: ${{ secrets.TF_STATE_SA }}

  # =========================================================================
  # Stage 5: Destroy (uses Level 2 reusable workflow → Level 1 composite actions)
  # =========================================================================
  destroy:
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'destroy'
    uses: ./.github/workflows/_destroy.yml
    with:
      terraform_version: '1.9.0'
      environment: ${{ github.event.inputs.environment }}
      var_file: environments/${{ github.event.inputs.environment }}.tfvars
      confirm: ${{ github.event.inputs.destroy_confirm }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_SA: ${{ secrets.TF_STATE_SA }}
