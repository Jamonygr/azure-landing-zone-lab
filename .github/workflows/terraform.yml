# =============================================================================
# TERRAFORM PIPELINE - Azure Landing Zone
# =============================================================================
# 8 jobs matching original visual, using hidden composite actions for code reuse
# =============================================================================

name: 'Terraform Pipeline'

on:
  push:
    branches: [main]
    paths: ['**.tf', '**.tfvars', 'modules/**', 'landing-zones/**', 'environments/**']
  pull_request:
    branches: [main]
    paths: ['**.tf', '**.tfvars']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'lab'
        type: choice
        options: [dev, lab, prod]
      action:
        description: 'Action'
        required: true
        default: 'plan'
        type: choice
        options: [plan, apply, destroy]
      destroy_confirm:
        description: 'Type DESTROY to confirm'
        required: false
        type: string

concurrency:
  group: terraform-${{ github.ref }}-${{ github.event.inputs.environment || 'lab' }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write
  security-events: write
  id-token: write

env:
  TF_VERSION: '1.9.0'
  ENVIRONMENT: ${{ github.event.inputs.environment || 'lab' }}

jobs:
  # =========================================================================
  # STAGE 1: FORMAT CHECK
  # =========================================================================
  format:
    name: '1Ô∏è‚É£ Format Check'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Format Check
        run: |
          if ! terraform fmt -check -recursive -diff; then
            echo "## ‚ùå Format Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "Run \`terraform fmt -recursive\` locally to fix." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "## ‚úÖ Format Check Passed" >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # STAGE 2: VALIDATE
  # =========================================================================
  validate:
    name: '2Ô∏è‚É£ Validate'
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Validate
        run: |
          terraform init -backend=false
          terraform validate
          echo "## ‚úÖ Validation Passed" >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # STAGE 3: SECURITY - TFSEC (parallel)
  # =========================================================================
  security-tfsec:
    name: '3Ô∏è‚É£ Security - tfsec'
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true
          format: sarif
          out: tfsec-results.sarif
        continue-on-error: true

      - uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: tfsec-results.sarif
        continue-on-error: true

      - run: echo "## üîí tfsec scan completed" >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # STAGE 3: SECURITY - CHECKOV (parallel)
  # =========================================================================
  security-checkov:
    name: '3Ô∏è‚É£ Security - Checkov'
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
        continue-on-error: true

      - uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

      - run: echo "## üõ°Ô∏è Checkov scan completed" >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # STAGE 4: TFLINT
  # =========================================================================
  tflint:
    name: '4Ô∏è‚É£ TFLint'
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: terraform-linters/setup-tflint@v4

      - name: Run TFLint
        run: |
          cat > .tflint.hcl << 'EOF'
          plugin "azurerm" {
            enabled = true
            version = "0.27.0"
            source  = "github.com/terraform-linters/tflint-ruleset-azurerm"
          }
          EOF
          tflint --init
          echo "## üìè TFLint Results" >> $GITHUB_STEP_SUMMARY
          tflint --recursive || true
        continue-on-error: true

  # =========================================================================
  # STAGE 5: PLAN (uses composite action)
  # =========================================================================
  plan:
    name: '5Ô∏è‚É£ Plan'
    runs-on: ubuntu-latest
    needs: [security-tfsec, security-checkov, tflint]
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
      add: ${{ steps.plan.outputs.add }}
      change: ${{ steps.plan.outputs.change }}
      destroy: ${{ steps.plan.outputs.destroy }}
    steps:
      - uses: actions/checkout@v4

      - name: Plan
        id: plan
        uses: ./.github/actions/plan
        with:
          terraform_version: ${{ env.TF_VERSION }}
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          backend_resource_group: ${{ secrets.TF_STATE_RG }}
          backend_storage_account: ${{ secrets.TF_STATE_SA }}
          state_key: ${{ env.ENVIRONMENT }}.terraform.tfstate
          var_file: environments/${{ env.ENVIRONMENT }}.tfvars
          environment: ${{ env.ENVIRONMENT }}

  # =========================================================================
  # STAGE 6: APPLY (uses composite action)
  # =========================================================================
  apply:
    name: '6Ô∏è‚É£ Apply'
    runs-on: ubuntu-latest
    needs: plan
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'apply' &&
      needs.plan.outputs.has_changes == 'true'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Apply
        uses: ./.github/actions/apply
        with:
          terraform_version: ${{ env.TF_VERSION }}
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          backend_resource_group: ${{ secrets.TF_STATE_RG }}
          backend_storage_account: ${{ secrets.TF_STATE_SA }}
          state_key: ${{ env.ENVIRONMENT }}.terraform.tfstate
          environment: ${{ env.ENVIRONMENT }}
          plan_artifact: tfplan-${{ env.ENVIRONMENT }}-${{ github.sha }}

  # =========================================================================
  # STAGE 7: DESTROY (uses composite action)
  # =========================================================================
  destroy:
    name: '7Ô∏è‚É£ Destroy'
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'destroy'
    environment: ${{ github.event.inputs.environment }}-destroy
    steps:
      - uses: actions/checkout@v4

      - name: Destroy
        uses: ./.github/actions/destroy
        with:
          terraform_version: ${{ env.TF_VERSION }}
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          backend_resource_group: ${{ secrets.TF_STATE_RG }}
          backend_storage_account: ${{ secrets.TF_STATE_SA }}
          state_key: ${{ env.ENVIRONMENT }}.terraform.tfstate
          var_file: environments/${{ env.ENVIRONMENT }}.tfvars
          environment: ${{ env.ENVIRONMENT }}
          confirm: ${{ github.event.inputs.destroy_confirm }}
