# =============================================================================
# TERRAFORM PIPELINE - Azure Landing Zone (Extended)
# =============================================================================
# Full-featured pipeline with security, cost estimation, testing, and more
# =============================================================================

name: 'Terraform Pipeline'

on:
  push:
    branches: [main]
    paths: ['**.tf', '**.tfvars', 'modules/**', 'landing-zones/**', 'environments/**']
  pull_request:
    branches: [main]
    paths: ['**.tf', '**.tfvars']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'lab'
        type: choice
        options: [dev, lab, prod]
      action:
        description: 'Action'
        required: true
        default: 'plan'
        type: choice
        options: [plan, apply, destroy]
      destroy_confirm:
        description: 'Type DESTROY to confirm'
        required: false
        type: string
      run_tests:
        description: 'Run Terratest after apply'
        required: false
        default: false
        type: boolean

concurrency:
  group: terraform-${{ github.ref }}-${{ github.event.inputs.environment || 'lab' }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  security-events: write
  id-token: write

env:
  TF_VERSION: '1.9.0'
  ENVIRONMENT: ${{ github.event.inputs.environment || 'lab' }}

jobs:
  # =========================================================================
  # STAGE 1: FORMAT CHECK
  # =========================================================================
  format:
    name: '1Ô∏è‚É£ Format Check'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Format Check
        run: |
          if ! terraform fmt -check -recursive -diff; then
            echo "## ‚ùå Format Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "Run \`terraform fmt -recursive\` locally to fix." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "## ‚úÖ Format Check Passed" >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # STAGE 2: VALIDATE
  # =========================================================================
  validate:
    name: '2Ô∏è‚É£ Validate'
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Validate
        run: |
          terraform init -backend=false
          terraform validate
          echo "## ‚úÖ Validation Passed" >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # STAGE 3: SECURITY - TFSEC
  # =========================================================================
  security-tfsec:
    name: '3Ô∏è‚É£ tfsec'
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true
          format: sarif
          out: tfsec-results.sarif
        continue-on-error: true

      - uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: tfsec-results.sarif
        continue-on-error: true

      - run: echo "## üîí tfsec scan completed" >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # STAGE 3: SECURITY - CHECKOV
  # =========================================================================
  security-checkov:
    name: '3Ô∏è‚É£ Checkov'
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
        continue-on-error: true

      - uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

      - run: echo "## üõ°Ô∏è Checkov scan completed" >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # STAGE 3: SECRET SCANNING (NEW)
  # =========================================================================
  secret-scan:
    name: '3Ô∏è‚É£ Secret Scan'
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/secret-scan

  # =========================================================================
  # STAGE 4: TFLINT
  # =========================================================================
  tflint:
    name: '4Ô∏è‚É£ TFLint'
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: terraform-linters/setup-tflint@v4

      - name: Run TFLint
        run: |
          cat > .tflint.hcl << 'EOF'
          plugin "azurerm" {
            enabled = true
            version = "0.27.0"
            source  = "github.com/terraform-linters/tflint-ruleset-azurerm"
          }
          EOF
          tflint --init
          echo "## üìè TFLint Results" >> $GITHUB_STEP_SUMMARY
          tflint --recursive || true
        continue-on-error: true

  # =========================================================================
  # STAGE 4: POLICY CHECK (NEW)
  # =========================================================================
  policy-check:
    name: '4Ô∏è‚É£ Policy (OPA)'
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Init for Policy Check
        run: terraform init -backend=false

      - uses: ./.github/actions/policy-check
        with:
          policy_dir: policies
          soft_fail: 'true'

  # =========================================================================
  # STAGE 4: TERRAFORM DOCS (NEW)
  # =========================================================================
  terraform-docs:
    name: '4Ô∏è‚É£ Docs'
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/terraform-docs
        with:
          recursive: 'true'

  # =========================================================================
  # STAGE 5: GRAPH VISUALIZATION (NEW)
  # =========================================================================
  graph:
    name: '5Ô∏è‚É£ Graph'
    runs-on: ubuntu-latest
    needs: [security-tfsec, security-checkov, secret-scan, tflint, policy-check]
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - uses: ./.github/actions/graph
        with:
          output_format: svg

  # =========================================================================
  # STAGE 5: MODULE VERSION CHECK (NEW)
  # =========================================================================
  module-versions:
    name: '5Ô∏è‚É£ Versions'
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Init
        run: terraform init -backend=false

      - uses: ./.github/actions/module-version

  # =========================================================================
  # STAGE 6: COST ESTIMATION (NEW)
  # =========================================================================
  cost-estimate:
    name: '6Ô∏è‚É£ Cost'
    runs-on: ubuntu-latest
    needs: [graph, module-versions]
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Init
        run: terraform init -backend=false

      - uses: ./.github/actions/cost-estimate
        with:
          api_key: ${{ secrets.INFRACOST_API_KEY }}
          var_file: environments/${{ env.ENVIRONMENT }}.tfvars
        continue-on-error: true

  # =========================================================================
  # STAGE 7: PLAN
  # =========================================================================
  plan:
    name: '7Ô∏è‚É£ Plan'
    runs-on: ubuntu-latest
    needs: [graph, module-versions]
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
      add: ${{ steps.plan.outputs.add }}
      change: ${{ steps.plan.outputs.change }}
      destroy: ${{ steps.plan.outputs.destroy }}
    steps:
      - uses: actions/checkout@v4

      - name: Plan
        id: plan
        uses: ./.github/actions/plan
        with:
          terraform_version: ${{ env.TF_VERSION }}
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          backend_resource_group: ${{ secrets.TF_STATE_RG }}
          backend_storage_account: ${{ secrets.TF_STATE_SA }}
          state_key: ${{ env.ENVIRONMENT }}.terraform.tfstate
          var_file: environments/${{ env.ENVIRONMENT }}.tfvars
          environment: ${{ env.ENVIRONMENT }}

  # =========================================================================
  # STAGE 8: APPLY
  # =========================================================================
  apply:
    name: '8Ô∏è‚É£ Apply'
    runs-on: ubuntu-latest
    needs: [plan, cost-estimate]
    if: |
      always() &&
      needs.plan.result == 'success' &&
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'apply' &&
      needs.plan.outputs.has_changes == 'true'
    environment: ${{ github.event.inputs.environment }}
    outputs:
      start_time: ${{ steps.timer.outputs.start }}
    steps:
      - uses: actions/checkout@v4

      - name: Start Timer
        id: timer
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: State Backup
        uses: ./.github/actions/state-backup
        with:
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          storage_account: ${{ secrets.TF_STATE_SA }}
          resource_group: ${{ secrets.TF_STATE_RG }}
          state_key: ${{ env.ENVIRONMENT }}.terraform.tfstate

      - name: Apply
        uses: ./.github/actions/apply
        with:
          terraform_version: ${{ env.TF_VERSION }}
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          backend_resource_group: ${{ secrets.TF_STATE_RG }}
          backend_storage_account: ${{ secrets.TF_STATE_SA }}
          state_key: ${{ env.ENVIRONMENT }}.terraform.tfstate
          environment: ${{ env.ENVIRONMENT }}
          plan_artifact: tfplan-${{ env.ENVIRONMENT }}-${{ github.sha }}

      - name: Resource Inventory
        uses: ./.github/actions/resource-inventory
        with:
          environment: ${{ env.ENVIRONMENT }}
          format: json

      - name: Change Log
        uses: ./.github/actions/changelog
        with:
          environment: ${{ env.ENVIRONMENT }}

  # =========================================================================
  # STAGE 9: DESTROY (with Approval Gate)
  # =========================================================================
  destroy:
    name: '9Ô∏è‚É£ Destroy'
    runs-on: ubuntu-latest
    needs: plan
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'destroy'
    environment: ${{ github.event.inputs.environment }}-destroy
    steps:
      - uses: actions/checkout@v4

      - name: State Backup Before Destroy
        uses: ./.github/actions/state-backup
        with:
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          storage_account: ${{ secrets.TF_STATE_SA }}
          resource_group: ${{ secrets.TF_STATE_RG }}
          state_key: ${{ env.ENVIRONMENT }}.terraform.tfstate

      - name: Destroy
        uses: ./.github/actions/destroy
        with:
          terraform_version: ${{ env.TF_VERSION }}
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          backend_resource_group: ${{ secrets.TF_STATE_RG }}
          backend_storage_account: ${{ secrets.TF_STATE_SA }}
          state_key: ${{ env.ENVIRONMENT }}.terraform.tfstate
          var_file: environments/${{ env.ENVIRONMENT }}.tfvars
          environment: ${{ env.ENVIRONMENT }}
          confirm: ${{ github.event.inputs.destroy_confirm }}

  # =========================================================================
  # STAGE 10: METRICS
  # =========================================================================
  metrics:
    name: 'üîü Metrics'
    runs-on: ubuntu-latest
    needs: [apply, plan]
    if: always() && needs.apply.result == 'success'
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/metrics
        with:
          environment: ${{ env.ENVIRONMENT }}
          action: ${{ github.event.inputs.action || 'plan' }}
          start_time: ${{ needs.apply.outputs.start_time || github.run_id }}
          status: ${{ needs.apply.result }}
          add_count: ${{ needs.plan.outputs.add || '0' }}
          change_count: ${{ needs.plan.outputs.change || '0' }}
          destroy_count: ${{ needs.plan.outputs.destroy || '0' }}

  # =========================================================================
  # STAGE 11: TERRATEST
  # =========================================================================
  terratest:
    name: '1Ô∏è‚É£1Ô∏è‚É£ Terratest'
    runs-on: ubuntu-latest
    needs: [apply, metrics]
    if: |
      always() &&
      needs.apply.result == 'success' &&
      github.event.inputs.run_tests == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/terratest
        with:
          test_directory: tests
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ env.ENVIRONMENT }}
          timeout: '10m'
