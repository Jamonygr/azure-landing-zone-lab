# =============================================================================
# TERRAFORM UNIFIED PIPELINE
# =============================================================================
# Single pipeline with all stages: Validate â†’ Security â†’ Plan â†’ Apply/Destroy
# =============================================================================

name: Terraform Pipeline

on:
  push:
    branches: [main]
    paths:
      - '**.tf'
      - '**.tfvars'
      - 'modules/**'
      - 'landing-zones/**'
      - 'environments/**'
  pull_request:
    branches: [main]
    paths:
      - '**.tf'
      - '**.tfvars'
      - 'modules/**'
      - 'landing-zones/**'
      - 'environments/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: 'Target environment'
        required: true
        default: 'lab'
        type: choice
        options:
          - lab
          - dev
          - prod
      destroy_confirm:
        description: 'Type DESTROY to confirm destruction'
        required: false
        type: string

concurrency:
  group: terraform-${{ github.ref }}-${{ github.event.inputs.environment || 'lab' }}
  cancel-in-progress: false

env:
  TF_VERSION: '1.9.0'
  TF_IN_AUTOMATION: 'true'
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  # ============================================================================
  # STAGE 1: FORMAT CHECK
  # ============================================================================
  format:
    name: '1ï¸âƒ£ Format Check'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: |
          if ! terraform fmt -check -recursive -diff; then
            echo "## âŒ Format Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "Run \`terraform fmt -recursive\` locally to fix." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "## âœ… Format Check Passed" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 2: VALIDATE
  # ============================================================================
  validate:
    name: '2ï¸âƒ£ Validate'
    runs-on: ubuntu-latest
    needs: format
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: |
          terraform validate
          echo "## âœ… Validation Passed" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 3: SECURITY SCANS (parallel)
  # ============================================================================
  security-tfsec:
    name: '3ï¸âƒ£ Security - tfsec'
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true
          format: sarif
          out: tfsec-results.sarif

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: tfsec-results.sarif
        continue-on-error: true

      - name: Summary
        run: echo "## ðŸ”’ tfsec scan completed" >> $GITHUB_STEP_SUMMARY

  security-checkov:
    name: '3ï¸âƒ£ Security - Checkov'
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

      - name: Summary
        run: echo "## ðŸ›¡ï¸ Checkov scan completed" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 4: TFLINT
  # ============================================================================
  tflint:
    name: '4ï¸âƒ£ TFLint'
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Init TFLint
        run: |
          cat > .tflint.hcl << 'EOF'
          plugin "azurerm" {
            enabled = true
            version = "0.27.0"
            source  = "github.com/terraform-linters/tflint-ruleset-azurerm"
          }
          EOF
          tflint --init

      - name: Run TFLint
        run: |
          echo "## ðŸ“ TFLint Results" >> $GITHUB_STEP_SUMMARY
          tflint --format=compact --recursive 2>&1 | tee tflint_output.txt || true
          if [ -s tflint_output.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat tflint_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No issues found" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

  # ============================================================================
  # STAGE 5: TERRAFORM PLAN
  # ============================================================================
  plan:
    name: '5ï¸âƒ£ Terraform Plan'
    runs-on: ubuntu-latest
    needs: [security-tfsec, security-checkov, tflint]
    if: |
      always() && 
      needs.security-tfsec.result != 'failure' && 
      needs.security-checkov.result != 'failure' &&
      (github.event.inputs.action != 'destroy' || github.event.inputs.action == '')
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
      add: ${{ steps.summary.outputs.add }}
      change: ${{ steps.summary.outputs.change }}
      destroy: ${{ steps.summary.outputs.destroy }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RG }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_SA }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ github.event.inputs.environment || 'lab' }}.terraform.tfstate"

      - name: Select Environment File
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'lab' }}"
          if [ -f "environments/${ENV}.tfvars" ]; then
            echo "varfile=environments/${ENV}.tfvars" >> $GITHUB_OUTPUT
          else
            echo "varfile=terraform.tfvars" >> $GITHUB_OUTPUT
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT

      - name: Terraform Plan
        id: plan
        run: |
          set +e
          set -o pipefail
          terraform plan \
            -var-file="${{ steps.env.outputs.varfile }}" \
            -out=tfplan \
            -detailed-exitcode \
            -no-color 2>&1 | tee plan_output.txt
          
          EXITCODE=${PIPESTATUS[0]}
          
          if [ $EXITCODE -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          elif [ $EXITCODE -eq 2 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            cat plan_output.txt
            exit 1
          fi

      - name: Parse Plan Output
        id: summary
        run: |
          ADD=$(grep -oP '\d+(?= to add)' plan_output.txt || echo "0")
          CHANGE=$(grep -oP '\d+(?= to change)' plan_output.txt || echo "0")
          DESTROY=$(grep -oP '\d+(?= to destroy)' plan_output.txt || echo "0")
          
          echo "add=$ADD" >> $GITHUB_OUTPUT
          echo "change=$CHANGE" >> $GITHUB_OUTPUT
          echo "destroy=$DESTROY" >> $GITHUB_OUTPUT

      - name: Plan Summary
        run: |
          echo "## ðŸ“‹ Terraform Plan - ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.plan.outputs.has_changes }}" == "false" ]; then
            echo "âœ… **No changes detected**" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Action | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âž• Add | ${{ steps.summary.outputs.add }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”„ Change | ${{ steps.summary.outputs.change }} |" >> $GITHUB_STEP_SUMMARY
            echo "| âž– Destroy | ${{ steps.summary.outputs.destroy }} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ steps.env.outputs.environment }}-${{ github.sha }}
          path: |
            tfplan
            plan_output.txt
          retention-days: 5

      - name: Comment on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('plan_output.txt', 'utf8');
            const truncated = plan.length > 60000 ? plan.substring(0, 60000) + '\n...(truncated)' : plan;
            
            const body = `## ðŸ“‹ Terraform Plan - ${{ steps.env.outputs.environment }}
            
            | Action | Count |
            |--------|-------|
            | âž• Add | ${{ steps.summary.outputs.add }} |
            | ðŸ”„ Change | ${{ steps.summary.outputs.change }} |
            | âž– Destroy | ${{ steps.summary.outputs.destroy }} |
            
            <details><summary>Show Plan</summary>
            
            \`\`\`hcl
            ${truncated}
            \`\`\`
            </details>
            
            *Workflow: [View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number
            });
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes('Terraform Plan'));
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner, repo: context.repo.repo, comment_id: existing.id, body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body: body
              });
            }

  # ============================================================================
  # STAGE 6: TERRAFORM APPLY
  # ============================================================================
  apply:
    name: '6ï¸âƒ£ Terraform Apply'
    runs-on: ubuntu-latest
    needs: plan
    if: |
      needs.plan.outputs.has_changes == 'true' && 
      (github.event_name == 'push' || github.event.inputs.action == 'apply')
    environment:
      name: ${{ github.event.inputs.environment || 'lab' }}
      url: https://portal.azure.com
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RG }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_SA }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ github.event.inputs.environment || 'lab' }}.terraform.tfstate"

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment || 'lab' }}-${{ github.sha }}

      - name: Terraform Apply
        run: |
          terraform apply -auto-approve tfplan 2>&1 | tee apply_output.txt
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "## âŒ Apply Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Apply Summary
        run: |
          echo "## âœ… Terraform Apply Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ github.event.inputs.environment || 'lab' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âž• Added | ${{ needs.plan.outputs.add }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Changed | ${{ needs.plan.outputs.change }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âž– Destroyed | ${{ needs.plan.outputs.destroy }} |" >> $GITHUB_STEP_SUMMARY

      - name: Show Outputs
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Outputs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform output -no-color >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No outputs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 7: TERRAFORM DESTROY (Manual only)
  # ============================================================================
  destroy-check:
    name: '7ï¸âƒ£ Destroy - Validate'
    runs-on: ubuntu-latest
    needs: [security-tfsec, security-checkov]
    if: github.event.inputs.action == 'destroy'
    steps:
      - name: Validate Confirmation
        if: github.event.inputs.destroy_confirm != 'DESTROY'
        run: |
          echo "## âŒ Destruction NOT Confirmed" >> $GITHUB_STEP_SUMMARY
          echo "You must type **DESTROY** to confirm." >> $GITHUB_STEP_SUMMARY
          echo "You entered: \`${{ github.event.inputs.destroy_confirm }}\`" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Confirmation Valid
        run: |
          echo "## âš ï¸ Destruction Confirmed" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY

  destroy:
    name: '7ï¸âƒ£ Destroy - Execute'
    runs-on: ubuntu-latest
    needs: destroy-check
    environment:
      name: ${{ github.event.inputs.environment }}-destroy
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RG }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_SA }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ github.event.inputs.environment }}.terraform.tfstate"

      - name: Select Environment File
        id: env
        run: |
          ENV="${{ github.event.inputs.environment }}"
          if [ -f "environments/${ENV}.tfvars" ]; then
            echo "varfile=environments/${ENV}.tfvars" >> $GITHUB_OUTPUT
          else
            echo "varfile=terraform.tfvars" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Destroy
        run: |
          terraform destroy \
            -var-file="${{ steps.env.outputs.varfile }}" \
            -auto-approve 2>&1 | tee destroy_output.txt
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "## âŒ Destroy Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Destroy Summary
        run: |
          echo "## ðŸ’¥ Environment Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Destroyed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # FINAL: PIPELINE SUMMARY
  # ============================================================================
  summary:
    name: 'ðŸ“Š Pipeline Summary'
    runs-on: ubuntu-latest
    needs: [format, validate, security-tfsec, security-checkov, tflint, plan, apply]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ—ï¸ Terraform Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ Format | ${{ needs.format.result == 'success' && 'âœ…' || needs.format.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2ï¸âƒ£ Validate | ${{ needs.validate.result == 'success' && 'âœ…' || needs.validate.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3ï¸âƒ£ tfsec | ${{ needs.security-tfsec.result == 'success' && 'âœ…' || needs.security-tfsec.result == 'skipped' && 'â­ï¸' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3ï¸âƒ£ Checkov | ${{ needs.security-checkov.result == 'success' && 'âœ…' || needs.security-checkov.result == 'skipped' && 'â­ï¸' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4ï¸âƒ£ TFLint | ${{ needs.tflint.result == 'success' && 'âœ…' || needs.tflint.result == 'skipped' && 'â­ï¸' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5ï¸âƒ£ Plan | ${{ needs.plan.result == 'success' && 'âœ…' || needs.plan.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 6ï¸âƒ£ Apply | ${{ needs.apply.result == 'success' && 'âœ…' || needs.apply.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ github.event.inputs.environment || 'lab' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
