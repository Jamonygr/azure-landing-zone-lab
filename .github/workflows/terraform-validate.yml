# =============================================================================
# TERRAFORM VALIDATE WORKFLOW
# =============================================================================
# Runs on PRs and pushes: format check, validate, security scans, linting
# =============================================================================

name: Terraform Validate

on:
  pull_request:
    branches: [main]
    paths:
      - '**.tf'
      - '**.tfvars'
      - 'modules/**'
      - 'landing-zones/**'
      - 'environments/**'
      - '.github/workflows/terraform-*.yml'
  push:
    branches: [main]
    paths:
      - '**.tf'
      - '**.tfvars'

env:
  TF_VERSION: '1.9.0'

jobs:
  # ============================================================================
  # FORMAT CHECK
  # ============================================================================
  format:
    name: ðŸ“ Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: |
          terraform fmt -check -recursive -diff 2>&1 | tee fmt_output.txt
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "## âŒ Format Check Failed" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            cat fmt_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`terraform fmt -recursive\` locally to fix." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "## âœ… Format Check Passed" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # VALIDATE
  # ============================================================================
  validate:
    name: âœ… Validate
    runs-on: ubuntu-latest
    needs: format
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: |
          terraform validate
          echo "## âœ… Validation Passed" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # SECURITY SCAN - TFSEC
  # ============================================================================
  security-tfsec:
    name: ðŸ”’ Security Scan (tfsec)
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true
          format: sarif
          out: tfsec-results.sarif

      - name: Upload SARIF to Security Tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: tfsec-results.sarif
        continue-on-error: true

      - name: tfsec Summary
        run: |
          echo "## ðŸ”’ tfsec Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "Results uploaded to Security tab" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # SECURITY SCAN - CHECKOV
  # ============================================================================
  security-checkov:
    name: ðŸ›¡ï¸ Security Scan (Checkov)
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
          download_external_modules: true

      - name: Upload SARIF to Security Tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

      - name: Checkov Summary
        run: |
          echo "## ðŸ›¡ï¸ Checkov Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "Results uploaded to Security tab" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # TFLINT
  # ============================================================================
  tflint:
    name: ðŸ“ TFLint
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Init TFLint
        run: |
          cat > .tflint.hcl << 'EOF'
          plugin "azurerm" {
            enabled = true
            version = "0.27.0"
            source  = "github.com/terraform-linters/tflint-ruleset-azurerm"
          }
          
          rule "terraform_deprecated_interpolation" {
            enabled = true
          }
          
          rule "terraform_unused_declarations" {
            enabled = true
          }
          
          rule "terraform_naming_convention" {
            enabled = true
          }
          EOF
          
          tflint --init

      - name: Run TFLint
        run: |
          echo "## ðŸ“ TFLint Results" >> $GITHUB_STEP_SUMMARY
          tflint --format=compact --recursive 2>&1 | tee tflint_output.txt || true
          
          if [ -s tflint_output.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat tflint_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No linting issues found!" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

  # ============================================================================
  # TERRAFORM DOCS
  # ============================================================================
  docs:
    name: ðŸ“š Docs Check
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check terraform-docs
        uses: terraform-docs/gh-actions@v1.2.0
        with:
          working-dir: .
          output-file: TERRAFORM-DOCS.md
          output-method: inject
          git-push: false
          fail-on-diff: false

      - name: Docs Summary
        run: |
          echo "## ðŸ“š Documentation Check" >> $GITHUB_STEP_SUMMARY
          echo "terraform-docs check completed" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # SECRET DETECTION
  # ============================================================================
  secrets:
    name: ðŸ” Secret Detection
    runs-on: ubuntu-latest
    needs: format
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Hardcoded Secrets
        run: |
          echo "## ðŸ” Secret Detection" >> $GITHUB_STEP_SUMMARY
          
          PATTERNS=(
            'password\s*=\s*"[^"$]+'
            'secret\s*=\s*"[^"$]+'
            'api_key\s*=\s*"[^"$]+'
            'client_secret\s*=\s*"[^"$]+'
          )
          
          FOUND=false
          for pattern in "${PATTERNS[@]}"; do
            if grep -rE "$pattern" --include="*.tf" --include="*.tfvars" . 2>/dev/null | grep -v "example\|template\|#\|var\.\|local\."; then
              FOUND=true
            fi
          done
          
          if [ "$FOUND" = true ]; then
            echo "âš ï¸ Potential hardcoded secrets detected. Review above matches." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No hardcoded secrets detected." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: ðŸ“ Summary
    runs-on: ubuntu-latest
    needs: [format, validate, security-tfsec, security-checkov, tflint, docs, secrets]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ—ï¸ Terraform Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Format | ${{ needs.format.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Validate | ${{ needs.validate.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ tfsec | ${{ needs.security-tfsec.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ Checkov | ${{ needs.security-checkov.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ TFLint | ${{ needs.tflint.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“š Docs | ${{ needs.docs.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Secrets | ${{ needs.secrets.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
