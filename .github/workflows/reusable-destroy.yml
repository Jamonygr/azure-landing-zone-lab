# =============================================================================
# LEVEL 2: REUSABLE WORKFLOW - Destroy
# =============================================================================
# Reusable workflow for Terraform destroy
# =============================================================================

name: Terraform Destroy

on:
  workflow_call:
    inputs:
      terraform_version:
        description: 'Terraform version'
        type: string
        required: false
        default: '1.9.0'
      working_directory:
        description: 'Working directory'
        type: string
        required: false
        default: '.'
      environment:
        description: 'Target environment'
        type: string
        required: true
      var_file:
        description: 'Variables file path'
        type: string
        required: true
      destroy_confirm:
        description: 'Confirmation string (must be DESTROY)'
        type: string
        required: true
    secrets:
      AZURE_CREDENTIALS:
        required: true
      TF_STATE_RG:
        required: true
      TF_STATE_SA:
        required: true

jobs:
  validate-confirmation:
    name: 'Validate Confirmation'
    runs-on: ubuntu-latest
    steps:
      - name: Check Confirmation
        if: inputs.destroy_confirm != 'DESTROY'
        run: |
          echo "## âŒ Destruction NOT Confirmed" >> $GITHUB_STEP_SUMMARY
          echo "You must type **DESTROY** to confirm." >> $GITHUB_STEP_SUMMARY
          echo "You entered: \`${{ inputs.destroy_confirm }}\`" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Confirmation Valid
        run: |
          echo "## âš ï¸ Destruction Confirmed" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY

  destroy:
    name: 'Terraform Destroy'
    runs-on: ubuntu-latest
    needs: validate-confirmation
    environment:
      name: ${{ inputs.environment }}-destroy
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        working-directory: ${{ inputs.working_directory }}
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RG }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_SA }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ inputs.environment }}.terraform.tfstate"

      - name: Terraform Destroy
        working-directory: ${{ inputs.working_directory }}
        run: |
          terraform destroy \
            -var-file="${{ inputs.var_file }}" \
            -auto-approve 2>&1 | tee destroy_output.txt
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "## âŒ Destroy Failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Destroy Summary
        run: |
          echo "## ðŸ’¥ Environment Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Destroyed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
