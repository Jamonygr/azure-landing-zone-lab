# =============================================================================
# LEVEL 3: MULTI-ENVIRONMENT ORCHESTRATOR
# =============================================================================
# Deploy to multiple environments in sequence (dev â†’ lab â†’ prod)
# Uses the same reusable workflows with environment gates
# =============================================================================

name: 'Terraform - Multi-Environment Deploy'

on:
  workflow_dispatch:
    inputs:
      deploy_dev:
        description: 'Deploy to DEV'
        type: boolean
        default: true
      deploy_lab:
        description: 'Deploy to LAB'
        type: boolean
        default: true
      deploy_prod:
        description: 'Deploy to PROD'
        type: boolean
        default: false
      skip_security:
        description: 'Skip security scans'
        type: boolean
        default: false

env:
  TF_VERSION: '1.9.0'

permissions:
  contents: read
  pull-requests: write
  security-events: write
  id-token: write

jobs:
  # ===========================================================================
  # Pre-flight Checks
  # ===========================================================================
  validate:
    name: 'Validate'
    uses: ./.github/workflows/reusable-validate.yml
    with:
      terraform_version: '1.9.0'

  security:
    name: 'Security'
    needs: validate
    if: inputs.skip_security != true
    uses: ./.github/workflows/reusable-security.yml
    with:
      soft_fail: true

  # ===========================================================================
  # DEV Environment
  # ===========================================================================
  plan-dev:
    name: 'Plan DEV'
    needs: [validate, security]
    if: |
      always() && 
      inputs.deploy_dev && 
      needs.validate.result == 'success' &&
      (needs.security.result == 'success' || needs.security.result == 'skipped')
    uses: ./.github/workflows/reusable-plan.yml
    with:
      environment: 'dev'
      var_file: 'environments/dev.tfvars'
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_SA: ${{ secrets.TF_STATE_SA }}

  apply-dev:
    name: 'Apply DEV'
    needs: plan-dev
    if: needs.plan-dev.outputs.has_changes == 'true'
    uses: ./.github/workflows/reusable-apply.yml
    with:
      environment: 'dev'
      plan_artifact: 'tfplan-dev-${{ github.sha }}'
      add_count: ${{ needs.plan-dev.outputs.add }}
      change_count: ${{ needs.plan-dev.outputs.change }}
      destroy_count: ${{ needs.plan-dev.outputs.destroy }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_SA: ${{ secrets.TF_STATE_SA }}

  # ===========================================================================
  # LAB Environment
  # ===========================================================================
  plan-lab:
    name: 'Plan LAB'
    needs: [apply-dev, validate, security]
    if: |
      always() && 
      inputs.deploy_lab && 
      needs.validate.result == 'success' &&
      (needs.security.result == 'success' || needs.security.result == 'skipped') &&
      (needs.apply-dev.result == 'success' || needs.apply-dev.result == 'skipped')
    uses: ./.github/workflows/reusable-plan.yml
    with:
      environment: 'lab'
      var_file: 'environments/lab.tfvars'
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_SA: ${{ secrets.TF_STATE_SA }}

  apply-lab:
    name: 'Apply LAB'
    needs: plan-lab
    if: needs.plan-lab.outputs.has_changes == 'true'
    uses: ./.github/workflows/reusable-apply.yml
    with:
      environment: 'lab'
      plan_artifact: 'tfplan-lab-${{ github.sha }}'
      add_count: ${{ needs.plan-lab.outputs.add }}
      change_count: ${{ needs.plan-lab.outputs.change }}
      destroy_count: ${{ needs.plan-lab.outputs.destroy }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_SA: ${{ secrets.TF_STATE_SA }}

  # ===========================================================================
  # PROD Environment
  # ===========================================================================
  plan-prod:
    name: 'Plan PROD'
    needs: [apply-lab, validate, security]
    if: |
      always() && 
      inputs.deploy_prod && 
      needs.validate.result == 'success' &&
      (needs.security.result == 'success' || needs.security.result == 'skipped') &&
      (needs.apply-lab.result == 'success' || needs.apply-lab.result == 'skipped')
    uses: ./.github/workflows/reusable-apply.yml
    with:
      environment: 'prod'
      var_file: 'environments/prod.tfvars'
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_SA: ${{ secrets.TF_STATE_SA }}

  apply-prod:
    name: 'Apply PROD'
    needs: plan-prod
    if: needs.plan-prod.outputs.has_changes == 'true'
    uses: ./.github/workflows/reusable-apply.yml
    with:
      environment: 'prod'
      plan_artifact: 'tfplan-prod-${{ github.sha }}'
      add_count: ${{ needs.plan-prod.outputs.add }}
      change_count: ${{ needs.plan-prod.outputs.change }}
      destroy_count: ${{ needs.plan-prod.outputs.destroy }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_SA: ${{ secrets.TF_STATE_SA }}

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: 'Deployment Summary'
    runs-on: ubuntu-latest
    needs: [apply-dev, apply-lab, apply-prod]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸŒ Multi-Environment Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| DEV | ${{ needs.apply-dev.result == 'success' && 'âœ… Deployed' || needs.apply-dev.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| LAB | ${{ needs.apply-lab.result == 'success' && 'âœ… Deployed' || needs.apply-lab.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PROD | ${{ needs.apply-prod.result == 'success' && 'âœ… Deployed' || needs.apply-prod.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
