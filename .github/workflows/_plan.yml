# Level 2: Reusable Workflow - Plan
# Called by main pipeline, NOT visible as separate workflow in GitHub

name: _plan

on:
  workflow_call:
    inputs:
      terraform_version:
        type: string
        default: '1.9.0'
      environment:
        type: string
        required: true
      var_file:
        type: string
        required: true
    secrets:
      AZURE_CREDENTIALS:
        required: true
      TF_STATE_RG:
        required: true
      TF_STATE_SA:
        required: true
    outputs:
      has_changes:
        value: ${{ jobs.plan.outputs.has_changes }}
      add:
        value: ${{ jobs.plan.outputs.add }}
      change:
        value: ${{ jobs.plan.outputs.change }}
      destroy:
        value: ${{ jobs.plan.outputs.destroy }}

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
      add: ${{ steps.summary.outputs.add }}
      change: ${{ steps.summary.outputs.change }}
      destroy: ${{ steps.summary.outputs.destroy }}
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/terraform-setup
        with:
          terraform_version: ${{ inputs.terraform_version }}
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: ./.github/actions/terraform-init
        with:
          backend_resource_group: ${{ secrets.TF_STATE_RG }}
          backend_storage_account: ${{ secrets.TF_STATE_SA }}
          backend_key: ${{ inputs.environment }}.terraform.tfstate

      - uses: ./.github/actions/terraform-plan
        id: plan
        with:
          var_file: ${{ inputs.var_file }}

      - name: Summary
        id: summary
        run: |
          ADD=$(grep -oP '\d+(?= to add)' plan_output.txt || echo "0")
          CHANGE=$(grep -oP '\d+(?= to change)' plan_output.txt || echo "0")
          DESTROY=$(grep -oP '\d+(?= to destroy)' plan_output.txt || echo "0")
          echo "add=$ADD" >> $GITHUB_OUTPUT
          echo "change=$CHANGE" >> $GITHUB_OUTPUT
          echo "destroy=$DESTROY" >> $GITHUB_OUTPUT
          
          echo "## ðŸ“‹ Plan - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âž• Add | $ADD |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Change | $CHANGE |" >> $GITHUB_STEP_SUMMARY
          echo "| âž– Destroy | $DESTROY |" >> $GITHUB_STEP_SUMMARY

      - uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ inputs.environment }}-${{ github.sha }}
          path: |
            tfplan
            plan_output.txt
          retention-days: 5
