# =============================================================================
# LEVEL 2: REUSABLE WORKFLOW - Validate
# =============================================================================
# Reusable workflow for format checking and validation
# =============================================================================

name: Validate

on:
  workflow_call:
    inputs:
      terraform_version:
        description: 'Terraform version'
        type: string
        required: false
        default: '1.9.0'
      working_directory:
        description: 'Working directory'
        type: string
        required: false
        default: '.'
    outputs:
      format_result:
        description: 'Format check result'
        value: ${{ jobs.format.outputs.result }}
      validate_result:
        description: 'Validation result'
        value: ${{ jobs.validate.outputs.result }}

jobs:
  format:
    name: 'Format Check'
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.fmt.outcome }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Terraform Format Check
        id: fmt
        run: |
          if terraform fmt -check -recursive -diff; then
            echo "## ✅ Format Check Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Format Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "Run \`terraform fmt -recursive\` locally to fix." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  validate:
    name: 'Validate'
    runs-on: ubuntu-latest
    needs: format
    outputs:
      result: ${{ steps.validate.outcome }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Terraform Init
        working-directory: ${{ inputs.working_directory }}
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        working-directory: ${{ inputs.working_directory }}
        run: |
          terraform validate
          echo "## ✅ Validation Passed" >> $GITHUB_STEP_SUMMARY
