# =============================================================================
# TERRAFORM PLAN WORKFLOW
# =============================================================================
# Runs on PRs: generates plan and comments on PR with changes
# =============================================================================

name: Terraform Plan

on:
  pull_request:
    branches: [main]
    paths:
      - '**.tf'
      - '**.tfvars'
      - 'modules/**'
      - 'landing-zones/**'
      - 'environments/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to plan'
        required: true
        default: 'lab'
        type: choice
        options:
          - lab
          - dev
          - prod

concurrency:
  group: terraform-plan-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_VERSION: '1.9.0'
  TF_IN_AUTOMATION: 'true'
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  # Pass subscription_id to Terraform via environment variable
  TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  plan:
    name: üìã Terraform Plan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
      add: ${{ steps.summary.outputs.add }}
      change: ${{ steps.summary.outputs.change }}
      destroy: ${{ steps.summary.outputs.destroy }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        id: init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RG }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_SA }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ github.event.inputs.environment || 'lab' }}.terraform.tfstate"

      - name: Select Environment File
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'lab' }}"
          if [ -f "environments/${ENV}.tfvars" ]; then
            echo "varfile=environments/${ENV}.tfvars" >> $GITHUB_OUTPUT
          else
            echo "varfile=terraform.tfvars" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Plan
        id: plan
        run: |
          set +e
          terraform plan \
            -var-file="${{ steps.env.outputs.varfile }}" \
            -out=tfplan \
            -detailed-exitcode \
            -no-color 2>&1 | tee plan_output.txt
          
          EXITCODE=$?
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
          
          # Exit code: 0 = no changes, 1 = error, 2 = changes present
          if [ $EXITCODE -eq 1 ]; then
            exit 1
          fi

      - name: Parse Plan Output
        id: summary
        run: |
          ADD=$(grep -oP '\d+(?= to add)' plan_output.txt || echo "0")
          CHANGE=$(grep -oP '\d+(?= to change)' plan_output.txt || echo "0")
          DESTROY=$(grep -oP '\d+(?= to destroy)' plan_output.txt || echo "0")
          
          echo "add=$ADD" >> $GITHUB_OUTPUT
          echo "change=$CHANGE" >> $GITHUB_OUTPUT
          echo "destroy=$DESTROY" >> $GITHUB_OUTPUT

      - name: Plan Summary
        run: |
          echo "## üìã Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ github.event.inputs.environment || 'lab' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Var File:** \`${{ steps.env.outputs.varfile }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          ADD=${{ steps.summary.outputs.add }}
          CHANGE=${{ steps.summary.outputs.change }}
          DESTROY=${{ steps.summary.outputs.destroy }}
          
          if [ "${{ steps.plan.outputs.exitcode }}" == "0" ]; then
            echo "‚úÖ **No changes detected**" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Action | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ûï Add | $ADD |" >> $GITHUB_STEP_SUMMARY
            echo "| üîÑ Change | $CHANGE |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ûñ Destroy | $DESTROY |" >> $GITHUB_STEP_SUMMARY
            
            if [ "$DESTROY" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ö†Ô∏è **Warning:** This plan includes resource destruction!" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment || 'lab' }}-${{ github.sha }}
          path: |
            tfplan
            plan_output.txt
          retention-days: 5

      - name: Comment on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('plan_output.txt', 'utf8');
            
            // Truncate if too long
            const maxLength = 60000;
            const truncatedPlan = plan.length > maxLength 
              ? plan.substring(0, maxLength) + '\n\n... (truncated, see artifacts for full output)'
              : plan;
            
            const add = '${{ steps.summary.outputs.add }}';
            const change = '${{ steps.summary.outputs.change }}';
            const destroy = '${{ steps.summary.outputs.destroy }}';
            const exitcode = '${{ steps.plan.outputs.exitcode }}';
            
            let summary = '';
            let icon = '‚úÖ';
            
            if (exitcode === '0') {
              summary = '‚úÖ **No infrastructure changes detected**';
            } else {
              summary = `| Action | Count |
            |--------|-------|
            | ‚ûï Add | ${add} |
            | üîÑ Change | ${change} |
            | ‚ûñ Destroy | ${destroy} |`;
              icon = destroy > 0 ? '‚ö†Ô∏è' : 'üìã';
            }
            
            const destroyWarning = destroy > 0 
              ? '\n\n‚ö†Ô∏è **Warning:** This plan will destroy resources! Please review carefully.' 
              : '';
            
            const body = `## ${icon} Terraform Plan Results
            
            **Environment:** \`${{ github.event.inputs.environment || 'lab' }}\`
            **Commit:** \`${{ github.sha }}\`
            
            ${summary}
            ${destroyWarning}
            
            <details>
            <summary>üìÑ Show Full Plan Output</summary>
            
            \`\`\`hcl
            ${truncatedPlan}
            \`\`\`
            
            </details>
            
            ---
            *Plan generated by GitHub Actions | [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Terraform Plan Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      - name: Add Labels for Destroy
        if: github.event_name == 'pull_request' && steps.summary.outputs.destroy > 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['terraform-destroy', 'needs-review']
            });

      - name: Plan Status
        if: steps.plan.outputs.exitcode == '1'
        run: exit 1
